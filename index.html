<script>
(function(){

  const form = document.getElementById('loanForm');
  const fullname = document.getElementById('fullname');
  const phone = document.getElementById('phone');
  const postal = document.getElementById('postal');
  const address = document.getElementById('address');
  const amount = document.getElementById('amount');

  const errFull = document.getElementById('err-fullname');
  const errPhone = document.getElementById('err-phone');
  const errPostal = document.getElementById('err-postal');
  const errAddr = document.getElementById('err-address');
  const errAmount = document.getElementById('err-amount');

  const submitBtn = document.getElementById('submitBtn');
  const resetBtn = document.getElementById('resetBtn');

  const modalBackdrop = document.getElementById('modalBackdrop');
  const summaryBox = document.getElementById('summaryBox');
  const trackCodeEl = document.getElementById('trackCode');
  const copySummary = document.getElementById('copySummary');
  const confirmBtn = document.getElementById('confirmBtn');

  let trackInput = document.getElementById('track_input');
  if(!trackInput){
    trackInput = document.createElement('input');
    trackInput.type = 'hidden';
    trackInput.id = 'track_input';
    trackInput.name = 'track_code';
    form.appendChild(trackInput);
  }

  function showError(el){ el.style.display = 'block'; }
  function hideError(el){ el.style.display = 'none'; }
  function isDigitsOnly(str){ return /^\d+$/.test(str); }

  function validate(){
    let ok = true;
    if(!fullname.value.trim()){ showError(errFull); ok=false; } else hideError(errFull);
    const ph = (phone.value||'').replace(/\s+/g,''); if(!ph||!isDigitsOnly(ph)||ph.length<10){showError(errPhone); ok=false;}else hideError(errPhone);
    const pc = (postal.value||'').replace(/\s+/g,''); if(!pc||!isDigitsOnly(pc)||pc.length!==10){showError(errPostal); ok=false;}else hideError(errPostal);
    if(!address.value.trim()){ showError(errAddr); ok=false;} else hideError(errAddr);
    const amt = Number(amount.value); if(!amt||amt<=0){showError(errAmount); ok=false;} else hideError(errAmount);
    return ok;
  }

  function formatNumberWithSep(n){try{return Number(n).toLocaleString('fa-IR');}catch(e){return n;}}

  function generateTrackingCode(){return Math.floor(Math.random()*100000000).toString().padStart(8,'0');}

  function openModal(data){
    summaryBox.innerHTML = `
      <div class="small"><strong>نام و نام خانوادگی:</strong> ${escapeHtml(data.fullname)}</div>
      <div class="small"><strong>شماره همراه:</strong> ${escapeHtml(data.phone)}</div>
      <div class="small"><strong>کد پستی:</strong> ${escapeHtml(data.postal)}</div>
      <div class="small"><strong>آدرس:</strong> ${escapeHtml(data.address).replace(/\\n/g,'<br/>')}</div>
      <div class="small"><strong>مبلغ درخواست (ریال):</strong> ${formatNumberWithSep(data.amount)}</div>
    `;
    const code = generateTrackingCode();
    trackCodeEl.innerText = code;
    trackInput.value = code;
    modalBackdrop.style.display = 'flex';
    modalBackdrop.setAttribute('aria-hidden','false');
  }

  function closeModal(){ modalBackdrop.style.display='none'; modalBackdrop.setAttribute('aria-hidden','true'); }

  function escapeHtml(unsafe){return (unsafe+'').replace(/[&<>"'`=\/]/g,function(s){return({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[s];});}

  submitBtn.addEventListener('click',function(e){
    e.preventDefault();
    if(!validate()){const firstErr = document.querySelector('.error[style*="display: block"]');if(firstErr) firstErr.scrollIntoView({behavior:'smooth', block:'center'}); return;}
    const data={fullname:fullname.value.trim(), phone:phone.value.trim(), postal:postal.value.trim(), address:address.value.trim(), amount:Number(amount.value)};
    openModal(data);
  });

  resetBtn.addEventListener('click', function(){ [errFull,errPhone,errPostal,errAddr,errAmount].forEach(hideError); closeModal(); });

  copySummary.addEventListener('click',function(){ const text = summaryBox.innerText + "\\nکد پیگیری: "+trackCodeEl.innerText; navigator.clipboard.writeText(text).then(()=>{alert('مشخصات و کد پیگیری کپی شد.');},()=>{alert('کپی انجام نشد — لطفاً دستی کپی کنید.');}); });

  confirmBtn.addEventListener('click',function(){
    confirmBtn.disabled=true;
    confirmBtn.innerText='در حال ثبت...';

    const dataSend = {
      fullname: fullname.value.trim(),
      phone: phone.value.trim(),
      postal: postal.value.trim(),
      address: address.value.trim(),
      amount: Number(amount.value),
      track: trackCodeEl.innerText || trackInput.value || generateTrackingCode()
    };

    alert('درخواست شما با موفقیت ثبت شد. کد پیگیری: '+dataSend.track);
    closeModal();
    form.reset();
    confirmBtn.disabled=false;
    confirmBtn.innerText='تأیید و ثبت نهایی';
  });

  modalBackdrop.addEventListener('click',function(e){if(e.target===modalBackdrop) closeModal();});
  form.addEventListener('keydown',function(e){if(e.key==='Enter'){e.preventDefault(); submitBtn.click();}});

})();
</script>
