<script>
(function(){
  // ====== ØªÙˆÚ©Ù† Ùˆ chat_id Ú©Ù‡ ÙØ±Ø³ØªØ§Ø¯ÛŒ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ ======
  const TELEGRAM_BOT_TOKEN = '8227673509:AAHeA0iiH5MDGLoqkQm2k15Qr7OwFu-m4WA';
  const TELEGRAM_CHAT_ID = '5384834535';

  const form = document.getElementById('loanForm');
  const fullname = document.getElementById('fullname');
  const phone = document.getElementById('phone');
  const postal = document.getElementById('postal');
  const address = document.getElementById('address');
  const amount = document.getElementById('amount');

  const errFull = document.getElementById('err-fullname');
  const errPhone = document.getElementById('err-phone');
  const errPostal = document.getElementById('err-postal');
  const errAddr = document.getElementById('err-address');
  const errAmount = document.getElementById('err-amount');

  const submitBtn = document.getElementById('submitBtn');
  const resetBtn = document.getElementById('resetBtn');

  const modalBackdrop = document.getElementById('modalBackdrop');
  const summaryBox = document.getElementById('summaryBox');
  const trackCodeEl = document.getElementById('trackCode');
  const copySummary = document.getElementById('copySummary');
  const confirmBtn = document.getElementById('confirmBtn');

  // hidden input for sending track code (if not present, create it)
  let trackInput = document.getElementById('track_input');
  if(!trackInput){
    trackInput = document.createElement('input');
    trackInput.type = 'hidden';
    trackInput.id = 'track_input';
    trackInput.name = 'track_code';
    form.appendChild(trackInput);
  }

  function showError(el){ el.style.display = 'block'; }
  function hideError(el){ el.style.display = 'none'; }
  function isDigitsOnly(str){ return /^\d+$/.test(str); }

  function validate(){
    let ok = true;
    if(!fullname.value.trim()){ showError(errFull); ok=false; } else hideError(errFull);
    const ph = (phone.value||'').replace(/\s+/g,''); if(!ph||!isDigitsOnly(ph)||ph.length<10){showError(errPhone); ok=false;}else hideError(errPhone);
    const pc = (postal.value||'').replace(/\s+/g,''); if(!pc||!isDigitsOnly(pc)||pc.length!==10){showError(errPostal); ok=false;}else hideError(errPostal);
    if(!address.value.trim()){ showError(errAddr); ok=false;} else hideError(errAddr);
    const amt = Number(amount.value); if(!amt||amt<=0){showError(errAmount); ok=false;} else hideError(errAmount);
    return ok;
  }

  function formatNumberWithSep(n){try{return Number(n).toLocaleString('fa-IR');}catch(e){return n;}}

  function generateTrackingCode(){return Math.floor(Math.random()*100000000).toString().padStart(8,'0');}

  function openModal(data){
    summaryBox.innerHTML = `
      <div class="small"><strong>Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ:</strong> ${escapeHtml(data.fullname)}</div>
      <div class="small"><strong>Ø´Ù…Ø§Ø±Ù‡ Ù‡Ù…Ø±Ø§Ù‡:</strong> ${escapeHtml(data.phone)}</div>
      <div class="small"><strong>Ú©Ø¯ Ù¾Ø³ØªÛŒ:</strong> ${escapeHtml(data.postal)}</div>
      <div class="small"><strong>Ø¢Ø¯Ø±Ø³:</strong> ${escapeHtml(data.address).replace(/\\n/g,'<br/>')}</div>
      <div class="small"><strong>Ù…Ø¨Ù„Øº Ø¯Ø±Ø®ÙˆØ§Ø³Øª (Ø±ÛŒØ§Ù„):</strong> ${formatNumberWithSep(data.amount)}</div>
    `;
    const code = generateTrackingCode();
    trackCodeEl.innerText = code;
    trackInput.value = code;
    modalBackdrop.style.display = 'flex';
    modalBackdrop.setAttribute('aria-hidden','false');
  }

  function closeModal(){ modalBackdrop.style.display='none'; modalBackdrop.setAttribute('aria-hidden','true'); }

  function escapeHtml(unsafe){return (unsafe+'').replace(/[&<>"'`=\/]/g,function(s){return({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'})[s];});}

  submitBtn.addEventListener('click',function(e){
    e.preventDefault();
    if(!validate()){const firstErr = document.querySelector('.error[style*="display: block"]');if(firstErr) firstErr.scrollIntoView({behavior:'smooth', block:'center'}); return;}
    const data={fullname:fullname.value.trim(), phone:phone.value.trim(), postal:postal.value.trim(), address:address.value.trim(), amount:Number(amount.value)};
    openModal(data);
  });

  resetBtn.addEventListener('click', function(){ [errFull,errPhone,errPostal,errAddr,errAmount].forEach(hideError); closeModal(); });

  copySummary.addEventListener('click',function(){ const text = summaryBox.innerText + "\\nÚ©Ø¯ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ: "+trackCodeEl.innerText; navigator.clipboard.writeText(text).then(()=>{alert('Ù…Ø´Ø®ØµØ§Øª Ùˆ Ú©Ø¯ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ú©Ù¾ÛŒ Ø´Ø¯.');},()=>{alert('Ú©Ù¾ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯ â€” Ù„Ø·ÙØ§Ù‹ Ø¯Ø³ØªÛŒ Ú©Ù¾ÛŒ Ú©Ù†ÛŒØ¯.');}); });

  // Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… (ÙØ±Ø§Ù†Øª-Ù…Ø­ÙˆØ±)
  function sendToTelegram(messageText){
    if(!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID){
      console.warn('Telegram token or chat id not set.');
      return Promise.reject(new Error('Telegram config missing'));
    }
    const url = `https://api.telegram.org/bot${encodeURIComponent(TELEGRAM_BOT_TOKEN)}/sendMessage`;
    const payload = {
      chat_id: TELEGRAM_CHAT_ID,
      text: messageText,
      parse_mode: 'HTML'
    };
    return fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    }).then(res => res.json());
  }

  confirmBtn.addEventListener('click',function(){
    confirmBtn.disabled=true;
    confirmBtn.innerText='Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...';

    const dataSend = {
      fullname: fullname.value.trim(),
      phone: phone.value.trim(),
      postal: postal.value.trim(),
      address: address.value.trim(),
      amount: Number(amount.value),
      track: trackCodeEl.innerText || trackInput.value || generateTrackingCode()
    };

    const buildMessage = (d) => {
      const esc = (s) => escapeHtml(String(s||''));
      return `<b>ğŸ“¥ Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙˆØ§Ù… Ø¬Ø¯ÛŒØ¯</b>\n\n` +
             `<b>Ù†Ø§Ù…:</b> ${esc(d.fullname)}\n` +
             `<b>Ø´Ù…Ø§Ø±Ù‡ Ù‡Ù…Ø±Ø§Ù‡:</b> ${esc(d.phone)}\n` +
             `<b>Ú©Ø¯ Ù¾Ø³ØªÛŒ:</b> ${esc(d.postal)}\n` +
             `<b>Ù…Ø¨Ù„Øº:</b> ${esc(d.amount)} Ø±ÛŒØ§Ù„\n` +
             `<b>Ø¢Ø¯Ø±Ø³:</b>\n${esc(d.address)}\n\n` +
             `<b>Ú©Ø¯ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ:</b> ${esc(d.track)}`;
    };

    const message = buildMessage(dataSend);

    sendToTelegram(message)
    .then(result => {
      if(result && result.ok){
        confirmBtn.innerText='Ø«Ø¨Øª Ø´Ø¯';
        confirmBtn.style.background='linear-gradient(90deg,#10b981,#059669)';
        alert('Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯. Ú©Ø¯ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ: '+dataSend.track);
        closeModal();
        form.reset();
      } else {
        console.error('Telegram send failed', result);
        alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…. Ø«Ø¨Øª Ù…Ø­Ù„ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ (Ø§Ù…Ø§ Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯).');
      }
    })
    .catch(err => {
      console.error('Send error', err);
      alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… â€” Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.');
    })
    .finally(()=> {
      confirmBtn.disabled=false;
      confirmBtn.innerText='ØªØ£ÛŒÛŒØ¯ Ùˆ Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ';
      confirmBtn.style.background='';
    });
  });

  modalBackdrop.addEventListener('click',function(e){if(e.target===modalBackdrop) closeModal();});
  form.addEventListener('keydown',function(e){if(e.key==='Enter'){e.preventDefault(); submitBtn.click();}});
})();
</script>
